{% extends 'partials/base.html' %}
{% load static %}

<style>
  #loading-spinner {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 3rem;
    height: 3rem;
    z-index: 1050;
  }
</style>

{% block content %}
<div class="mt-4 pt-5">
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          {% if order %}
            <a href="{% url 'order_details' order.id %}">Click here to see order details.</a>
          {% endif %}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
</div>

<div class="container-fluid mt-3 pt-4 animate-up">
  <div class="row mb-2">
    <h1 class="text-center">My Cart</h1>
  </div>

  <div id="content">
    {% if items %}
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Product</th>
            <th>Size</th>
            <th>Color</th>
            <th>Quantity</th>
            <th>Price</th>
            <th></th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
            <tr>
              <td>{{ item.product.name }}</td>
              <td>{{ item.size }}</td>
              <td>{{ item.color }}</td>
              <td>{{ item.quantity }}</td>
              <td><span>&#8373;</span>{{ item.price }}</td>
              <td>
                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#myModal{{ item.id }}">
                  Update
                </button>
                {% include 'partials/update_cart_modal.html' %}
              </td>
              <td>
                <a href="{% url 'remove_from_cart' item.id %}" class="btn btn-outline-danger btn-sm my-0 p-2"> Remove </a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="clearfix mt-3">
      <a href="{% url 'empty_cart' %}" class="btn btn-danger btn-md py-2 float-start">Empty Cart</a>

      <form id="order-form" method="post" action="{% url 'create_order' %}" class="float-end">
        {% csrf_token %}
        <button type="submit" class="btn btn-success px-4 py-2 me-2">Order</button>
      </form>
    </div>

    {% else %}
    <p>Your cart is currently empty</p>
  {% endif %}
  </div>
  
</div>

<!-- Spinner HTML -->
<div id="loading-spinner" class="spinner-border text-primary" role="status" style="display: none;">
  <span class="visually-hidden">Loading...</span>
</div>


<div class="modal fade" id="order-modal" tabindex="-1" aria-labelledby="order-modal-label" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body">
        <p id="modal-message"></p>
        <a id="order-link" href="#" style="display: none;">View Order</a>
      </div>
    </div>
  </div>
</div>

{% include 'partials/footer.html' %}
<!-- 
<script>
  document.addEventListener('DOMContentLoaded', function() {
      const content = document.querySelector("#content");
      const orderForm = document.querySelector("#order-form");
      const modal = new bootstrap.Modal(document.getElementById('order-modal'), {
          keyboard: false
      });
      const modalMessage = document.getElementById('modal-message');
      const orderLink = document.getElementById('order-link');
      const loadingSpinner = document.getElementById('loading-spinner');
  
      orderForm.addEventListener('submit', function(event) {
          event.preventDefault();

          // Show the loading spinner
          loadingSpinner.style.display = 'block';
  
          fetch('{% url "create_order" %}', {
              method: 'POST',
              headers: {
                  'X-CSRFToken': getCookie('csrftoken')
              },
              body: new FormData(orderForm)
          })
          .then(response => response.json())
          .then(data => {

            // Hide the loading spinner
            loadingSpinner.style.display = 'none';

              if (data.success) {
                  modalMessage.textContent = 'Order has been successfully placed.';
                  modalMessage.classList.add('success-message');
                  modalMessage.classList.remove('error-message');
                  content.textContent = "Cart is currently empty.";
                  orderLink.href = `/order_details/${data.order_id}/`;
                  orderLink.style.display = 'inline'; // Show the order link
                  modal.show();
              } else {
                  modalMessage.textContent = data.error_message;
                  modalMessage.classList.add('error-message');
                  modalMessage.classList.remove('success-message');
                  orderLink.style.display = 'none'; // Hide the order link
                  modal.show();

                  // Hide the loading spinner
                  loadingSpinner.style.display = 'none';
              }
          })
          .catch(error => {
              console.error('Error:', error);
          });
      });
  
      // Function to get CSRF token from cookies
      function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }
  });
  </script>
   -->


   <script>
    document.addEventListener('DOMContentLoaded', function() {
      const content = document.querySelector("#content");
        const orderForm = document.querySelector("#order-form");
        const modal = new bootstrap.Modal(document.getElementById('order-modal'), {
            keyboard: false
        });
        const modalMessage = document.getElementById('modal-message');
        const orderLink = document.getElementById('order-link');
        const loadingSpinner = document.getElementById('loading-spinner');

        orderForm.addEventListener('submit', function(event) {
            event.preventDefault();

            // Show the loading spinner
            loadingSpinner.style.display = 'block';

            fetch('{% url "create_order" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: new FormData(orderForm)
            })
            .then(response => response.json())
            .then(data => {
                // Hide the loading spinner
                loadingSpinner.style.display = 'none';

                if (data.success) {
                    modalMessage.textContent = 'Order has been successfully placed.';
                    modalMessage.classList.add('success-message');
                    modalMessage.classList.remove('error-message');
                    orderLink.href = `/order_details/${data.order_id}/`;
                    orderLink.style.display = 'inline'; // Show the order link
                    modal.show();
                    content.textContent = "Cart is currently empty";
                } else {
                    if (data.error_message.includes("AnonymousUser")) {
                        modalMessage.textContent = "You need to be logged in to place an order.";
                        window.location.href = "{% url 'login' %}";
                    } else {
                        modalMessage.textContent = data.error_message;
                        modalMessage.classList.add('error-message');
                        modalMessage.classList.remove('success-message');
                        orderLink.style.display = 'none'; // Hide the order link
                        modal.show();
                    }
                }
            })
            .catch(error => {
                // Hide the loading spinner
                loadingSpinner.style.display = 'none';
                console.error('Error:', error);
            });
        });

        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
    </script>
{% endblock %}
